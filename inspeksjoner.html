<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Mine inspeksjoner - BirÃ¸kter App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #FFF8F0; }
    @media print {
        body * { visibility: hidden; }
        #print_area, #print_area * { visibility: visible; }
        #print_area { position: absolute; left: 0; top: 0; width: 100%; }
        .no-print { display: none !important; }
    }
  </style>
    <link rel="icon" type="image/png" href="assets/icon_square.png">
    <link rel="apple-touch-icon" href="assets/icon_square.png">
</head>
<body class="bg-gray-50">

  <!-- App Viewport Container -->
  <div class="app-viewport">
    
    <!-- Header Container -->
    <div id="app-header"></div>

    <!-- Scrollable Content -->
    <div class="app-content p-4">
      <h1 class="text-2xl font-bold mb-6 text-black text-center">Mine inspeksjoner</h1>
      <div class="space-y-2 mb-4 no-print">
        <input id="search_general" type="text" placeholder="SÃ¸k (Kube, BigÃ¥rd, Dato, Notat...)" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#FFD700]">
        
        <!-- Filter Row -->
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <label class="flex items-center space-x-2 text-sm">
              <input id="filter_last30" type="checkbox" class="rounded text-[#FFD700] focus:ring-[#FFD700]">
              <span>Siste 30 dager</span>
            </label>
            <label class="flex items-center space-x-2 text-sm">
              <input id="filter_severity" type="checkbox" class="rounded text-[#FFD700] focus:ring-[#FFD700]">
              <span>Bare rÃ¸de/gule statuser</span>
            </label>
          </div>
        </div>

        <!-- Print Button -->
        <button onclick="window.print()" class="w-full bg-white border-2 border-black text-black font-bold py-2 rounded shadow-sm hover:bg-gray-50 uppercase text-xs tracking-wider mt-2">
            SKRIV UT INSPEKSJONSRAPPORT
        </button>
      </div>
      <div id="insp_empty" class="text-gray-600 text-center mb-4"></div>
      <div id="insp_list" class="space-y-3"></div>
      
      <!-- Dropdown for older items -->
      <div id="insp_dropdown_container" class="mt-4 hidden no-print">
        <label class="block text-sm font-medium text-gray-700 mb-1">Eldre inspeksjoner</label>
        <select id="insp_dropdown" class="w-full border border-gray-300 rounded px-3 py-3 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#FFD700]" onchange="renderSingleFromDropdown(this.value)">
          <option value="">Velg eldre inspeksjon...</option>
        </select>
      </div>

      <div id="print_area" class="hidden print:block">
          <table class="w-full border-collapse text-sm">
              <thead>
                  <tr class="bg-gray-100">
                      <th class="border border-gray-300 p-2 font-bold">Dato</th>
                      <th class="border border-gray-300 p-2 font-bold">Kube</th>
                      <th class="border border-gray-300 p-2 font-bold">Status</th>
                      <th class="border border-gray-300 p-2 font-bold">Notat</th>
                      <th class="border border-gray-300 p-2 font-bold">Bilde</th>
                  </tr>
              </thead>
              <tbody id="print_tbody"></tbody>
          </table>
      </div>

      <!-- Action Buttons -->
      <div class="w-full space-y-4 pt-4 no-print pb-6">
          <button onclick="window.print()" class="btn-primary">
              Skriv ut / Lagre som PDF
          </button>
      </div>

    </div>
    <div id="app-footer"></div>
  </div>
  <script>
    function statusColor(s) {
      const n = (s || '').toUpperCase();
      if (n === 'OK') return 'bg-green-500';
      if (n === 'DÃ˜D') return 'bg-red-600';
      if (n === 'SYKDOM' || n === 'VARROA MISTANKE') return 'bg-orange-500';
      if (n === 'BYTT DRONNING') return 'bg-purple-500';
      if (n === 'TRENGER FÃ”R' || n === 'FOR LITE MAT') return 'bg-amber-500';
      if (n === 'MOTTATT FÃ”R' || n === 'SKIFTET RAMMER' || n === 'DRONNING SETT') return 'bg-blue-500';
      if (n === 'SVARMING') return 'bg-red-500';
      return 'bg-gray-400';
    }
    function statusIcon(s) {
      const n = (s || '').toUpperCase();
      if (n === 'OK') return 'âœ…';
      if (n === 'DÃ˜D') return 'â›”';
      if (n === 'SYKDOM' || n === 'VARROA MISTANKE') return 'âš ï¸';
      if (n === 'BYTT DRONNING') return 'ðŸ‘‘';
      if (n === 'TRENGER FÃ”R' || n === 'FOR LITE MAT') return 'ðŸ¯';
      if (n === 'MOTTATT FÃ”R') return 'ðŸ“¦';
      if (n === 'SKIFTET RAMMER') return 'ðŸªµ';
      if (n === 'DRONNING SETT') return 'ðŸ‘€';
      if (n === 'SVARMING') return 'ðŸ';
      return 'â„¹ï¸';
    }
    function severeStatus(s) {
      const n = (s || '').toUpperCase();
      return n === 'DÃ˜D' || n === 'SYKDOM' || n === 'VARROA MISTANKE' || n === 'TRENGER FÃ”R' || n === 'FOR LITE MAT' || n === 'SVARMING' || n === 'BYTT DRONNING';
    }
    function applyFilters() {
      let inspections = []; let hives = []; let apiaries = [];
      try { inspections = JSON.parse(localStorage.getItem('inspections') || '[]'); } catch (e) {}
      try { hives = JSON.parse(localStorage.getItem('hives') || '[]'); } catch (e) {}
      try { apiaries = JSON.parse(localStorage.getItem('apiaries') || '[]'); } catch (e) {}
      
      const params = new URLSearchParams(window.location.search);
      const filterHiveId = params.get('hive');

      const q = (document.getElementById('search_general')?.value || '').toLowerCase();
      const last30 = document.getElementById('filter_last30')?.checked || false;
      const onlySevere = document.getElementById('filter_severity')?.checked || false;
      const now = Date.now();
      const hiveToApiary = Object.fromEntries(hives.map(h => [h.id, h.apiaryId]));
      const apiaryName = Object.fromEntries(apiaries.map(a => [a.id, a.name || a.id]));
      
      // Filter Feedback
      const headerEl = document.querySelector('h1');
      if (filterHiveId) {
          headerEl.textContent = `Inspeksjoner: ${filterHiveId}`;
          // Also show a "Show All" button if filtered
          if (!document.getElementById('btn_clear_filter')) {
             const btn = document.createElement('button');
             btn.id = 'btn_clear_filter';
             btn.textContent = "Vis alle inspeksjoner";
             btn.className = "block mx-auto mb-4 text-sm text-[#FFD700] underline";
             btn.onclick = () => window.location.href = 'inspeksjoner.html';
             headerEl.after(btn);
          }
      } else {
          headerEl.textContent = 'Mine inspeksjoner';
          const btn = document.getElementById('btn_clear_filter');
          if (btn) btn.remove();
      }

      const filtered = inspections.filter(i => {
        if (filterHiveId && i.hiveId !== filterHiveId) return false;
        
        const apiaryId = hiveToApiary[i.hiveId] || '';
        const apiaryNameStr = (apiaryName[apiaryId] || '').toLowerCase();
        const hiveIdStr = (i.hiveId || '').toLowerCase();
        const noteStr = (i.note || '').toLowerCase();
        const dateStr = new Date(i.ts || 0).toLocaleString('no-NO').toLowerCase();

        if (q) {
            const match = 
                apiaryNameStr.includes(q) ||
                apiaryId.toLowerCase().includes(q) ||
                hiveIdStr.includes(q) ||
                noteStr.includes(q) ||
                dateStr.includes(q);
            if (!match) return false;
        }

        if (last30 && now - (i.ts || 0) > 30 * 24 * 3600 * 1000) return false;
        if (onlySevere && !severeStatus(i.status)) return false;
        return true;
      }).sort((a,b)=> (b.ts||0)-(a.ts||0));
      
      const emptyEl = document.getElementById('insp_empty');
      const listEl = document.getElementById('insp_list');
      const dropContainer = document.getElementById('insp_dropdown_container');
      const dropSelect = document.getElementById('insp_dropdown');

      if (!filtered.length) { 
          if (emptyEl) emptyEl.textContent = 'Ingen inspeksjoner funnet.'; 
          if (listEl) listEl.innerHTML = ''; 
          if (dropContainer) dropContainer.classList.add('hidden');
          return; 
      }
      
      if (emptyEl) emptyEl.textContent = '';
      
      // Show all inspections (no limit)
      renderList(filtered, listEl, hiveToApiary, apiaryName);
      
      // Hide dropdown container as we show everything in the list
      if (dropContainer) dropContainer.classList.add('hidden');

      renderPrintTable(filtered, hiveToApiary, apiaryName);
    }
    
    function renderPrintTable(items, hiveToApiary, apiaryName) {
        const tbody = document.getElementById('print_tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        items.forEach(i => {
            const tr = document.createElement('tr');
            const d = new Date(i.ts || Date.now());
            const dateStr = d.toLocaleDateString('no-NO');
            const timeStr = d.toLocaleTimeString('no-NO', {hour:'2-digit', minute:'2-digit'});
            
            const apiaryId = hiveToApiary[i.hiveId] || '';
            const apiaryNameStr = apiaryName[apiaryId] || apiaryId;
            
            const temp = i.temp ? `${i.temp}Â°C ` : '';
            const weather = i.weather ? i.weather : '';
            
            const imageCell = i.image ? `<img src="${i.image}" class="h-6 w-6 object-cover cursor-pointer mx-auto border border-gray-200" onclick="printImageA5('${i.image}')" title="Klikk for A5 utskrift">` : '-';
            
            tr.innerHTML = `
                <td class="border border-gray-300 p-2 whitespace-nowrap">${dateStr}<br><span class="text-gray-500">${timeStr}</span></td>
                <td class="border border-gray-300 p-2">${apiaryNameStr}</td>
                <td class="border border-gray-300 p-2 font-mono font-bold">${i.hiveId}</td>
                <td class="border border-gray-300 p-2">${temp}<br>${weather}</td>
                <td class="border border-gray-300 p-2 font-bold ${severeStatus(i.status) ? 'text-red-600' : 'text-green-600'}">${i.status}</td>
                <td class="border border-gray-300 p-2 italic">${i.note || '-'}</td>
                <td class="border border-gray-300 p-2 text-center">${imageCell}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function printImageA5(dataUrl) {
        const win = window.open('', '_blank');
        win.document.write(`
            <html>
            <head>
                <title>Utskrift Bilde A5</title>
                <style>
                    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
                    img { 
                        max-width: 148mm; 
                        max-height: 210mm; 
                        width: auto; height: auto;
                        object-fit: contain;
                    }
                    @media print {
                        @page { size: A5; margin: 0; }
                    }
                </style>
            </head>
            <body>
                <img src="${dataUrl}" onload="window.print(); window.close();">
            </body>
            </html>
        `);
        win.document.close();
    }

    function renderList(items, container, hiveToApiary, apiaryName) {
      container.innerHTML = '';
      items.forEach(i => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between border border-gray-200 rounded p-3 text-sm';
        const d = new Date(i.ts || Date.now());
        const dateStr = d.toLocaleDateString('no-NO');
        const timeStr = d.toLocaleTimeString('no-NO', {hour:'2-digit', minute:'2-digit'});
        
        const apiaryId = hiveToApiary[i.hiveId] || '';
        const name = apiaryName[apiaryId] || apiaryId;
        const left = document.createElement('div');
        left.className = 'flex items-center space-x-2';
        const icon = document.createElement('span'); icon.textContent = statusIcon(i.status);
        const text = document.createElement('div');
        text.className = 'flex flex-col';
        
        const mainLine = document.createElement('span');
        mainLine.className = 'font-semibold';
        mainLine.textContent = `${i.hiveId} â€¢ ${name}`;
        
        const subLine = document.createElement('span');
        subLine.className = 'text-xs text-gray-500';
        const note = (i.note || '').trim();
        // Format: Date Kl.Time Temp Weather Status [Note]
        // Example: 20.05.2024 Kl.14:30 20Â°C SOL â€¢ OK
        const temp = i.temp ? `${i.temp}Â°C ` : '';
        const weather = i.weather ? `${i.weather} ` : '';
        
        subLine.textContent = `${dateStr} Kl.${timeStr} ${temp}${weather}â€¢ ${i.status}${note ? ' â€¢ ' + note : ''}`;
        
        text.appendChild(mainLine);
        text.appendChild(subLine);
        
        left.appendChild(icon);
        left.appendChild(text);
        const dot = document.createElement('span');
        dot.className = `ml-3 inline-block w-2.5 h-2.5 rounded-full ${statusColor(i.status)}`;
        row.appendChild(left);
        row.appendChild(dot);
        container.appendChild(row);
      });
    }

    function renderSingleFromDropdown(id) {
        if (!id) return;
        let inspections = [];
        try { inspections = JSON.parse(localStorage.getItem('inspections') || '[]'); } catch (e) {}
        const item = inspections.find(i => i.id === id);
        if (item) {
             // Mock lookup maps
             let hives = []; let apiaries = [];
             try { hives = JSON.parse(localStorage.getItem('hives') || '[]'); } catch (e) {}
             try { apiaries = JSON.parse(localStorage.getItem('apiaries') || '[]'); } catch (e) {}
             const hiveToApiary = Object.fromEntries(hives.map(h => [h.id, h.apiaryId]));
             const apiaryName = Object.fromEntries(apiaries.map(a => [a.id, a.name || a.id]));
             
             // Render just this one into the list
             const listEl = document.getElementById('insp_list');
             renderList([item], listEl, hiveToApiary, apiaryName);
             
             // Optionally scroll to it
             listEl.scrollIntoView({ behavior: 'smooth' });
        }
    }
    document.getElementById('search_general')?.addEventListener('input', applyFilters);
    document.getElementById('filter_last30')?.addEventListener('change', applyFilters);
    document.getElementById('filter_severity')?.addEventListener('change', applyFilters);
    applyFilters();
  </script>
  <script src="header.js"></script>
  <link rel="manifest" href="manifest.json">
</body>
</html>
