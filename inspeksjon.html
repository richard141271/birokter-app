<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Inspeksjon - Birøkter App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        /* Hide scrollbar for button grid */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <link rel="icon" type="image/png" href="assets/icon_square.png">
    <link rel="apple-touch-icon" href="assets/icon_square.png">
</head>
<body class="bg-gray-50">

    <!-- App Viewport Container -->
    <div class="app-viewport">
        
        <!-- Header Container -->
        <div id="app-header"></div>

        <!-- Scrollable Content -->
        <div class="app-content p-4">
            <h1 id="insp_header" class="text-xl font-bold text-black text-center mb-4"></h1>

            <!-- INSPEKSJON Header -->
            <div class="w-full bg-black text-[#FFD700] font-bold text-center py-2.5 rounded mb-6 uppercase tracking-wider">
                INSPEKSJON
            </div>

            <form onsubmit="saveInspection(event)" class="space-y-4">
                
                <!-- <input type="hidden" id="status_input" value="OK"> -->
                
                <div class="text-sm text-gray-600 text-center">Dato: <span id="date_display"></span> • Klokkeslett: <span id="time_display"></span></div>
                
                <!-- TEMP & WEATHER -->
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" name="temp" placeholder="TEMP" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-[#FFD700] placeholder-gray-500 uppercase text-center">
                    <input type="text" name="weather" placeholder="VÆRET" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-[#FFD700] placeholder-gray-500 uppercase text-center">
                </div>

                <!-- NOTAT -->
                <div>
                    <input type="text" name="note" placeholder="NOTAT" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-[#FFD700] placeholder-gray-500 uppercase">
                </div>

                <!-- BILDE -->
                <div class="relative">
                    <button type="button" onclick="document.getElementById('fileInput').click()" class="w-full border border-gray-300 rounded px-3 py-3 text-gray-500 uppercase text-left hover:bg-gray-50 flex justify-between items-center focus:ring-2 focus:ring-[#FFD700]">
                        <span id="fileLabel">TA BILDE / VELG FIL</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                    <input type="file" id="fileInput" class="hidden" accept="image/*,application/pdf" capture="environment" onchange="handleFile(this)">
                </div>

                <!-- STATUS SELECT -->
                <div>
                    <label class="block text-gray-500 text-sm font-bold mb-2 uppercase">STATUS</label>
                    <select id="status_input" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-[#FFD700] uppercase bg-white text-gray-900 font-bold">
                        <!-- Options injected by JS -->
                    </select>
                </div>

                <!-- SAVE BUTTON -->
                <button type="submit" class="btn-primary mb-6">Lagre inspeksjon</button>


                <!-- Bottom Buttons Grid -->
                <!-- Removed sticky-footer-actions class to prevent overlap, increased margin -->
                <div class="grid grid-cols-2 gap-3 mt-6 pb-32">
                    <button type="button" onclick="window.location.href='bikuber.html'" class="w-full border border-gray-300 rounded px-3 py-3 text-gray-700 font-bold uppercase hover:bg-gray-50">
                        Avbryt
                    </button>
                    <button type="button" onclick="window.location.href='inspeksjoner.html'" class="w-full border border-gray-300 rounded px-3 py-3 text-gray-700 font-bold uppercase hover:bg-gray-50">
                        Mine Inspeksjoner
                    </button>
                </div>
            </form>
        </div>
        <div id="app-footer"></div>
    </div>

</body>
<script>
  function getParam(name) {
    const p = new URLSearchParams(window.location.search); return p.get(name);
  }

  // Define Status Options with Colors
  const statusOptions = [
    { val: 'OK', color: 'bg-green-500 text-white', label: 'OK' },
    { val: 'DØD', color: 'bg-red-600 text-white', label: 'DØD' },
    { val: 'SYKDOM', color: 'bg-orange-500 text-white', label: 'SYKDOM' },
    { val: 'BYTT DRONNING', color: 'bg-purple-500 text-white', label: 'BYTT DRONNING' },
    { val: 'TRENGER FÔR', color: 'bg-amber-500 text-white', label: 'TRENGER FÔR' },
    { val: 'MOTTATT FÔR', color: 'bg-blue-500 text-white', label: 'MOTTATT FÔR' },
    { val: 'SKIFTET RAMMER', color: 'bg-blue-500 text-white', label: 'SKIFTET RAMMER' },
    { val: 'DRONNING SETT', color: 'bg-blue-500 text-white', label: 'DRONNING SETT' },
    { val: 'SVARMING', color: 'bg-red-500 text-white', label: 'SVARMING' },
    { val: 'VARROA MISTANKE', color: 'bg-orange-500 text-white', label: 'VARROA MISTANKE' },
    { val: 'FOR LITE MAT', color: 'bg-amber-500 text-white', label: 'FOR LITE MAT' }
  ];

  function renderStatusOptions() {
      const select = document.getElementById('status_input');
      if (!select) return;
      select.innerHTML = '';
      
      statusOptions.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.val;
          option.textContent = opt.label;
          select.appendChild(option);
      });
  }

  function handleFile(input) {
      const label = document.getElementById('fileLabel');
      if (input.files && input.files.length > 0) {
          label.textContent = `Fil valgt: ${input.files[0].name}`;
      } else {
          label.textContent = 'TA BILDE / VELG FIL';
      }
  }

  function saveInspection(e) {
    e.preventDefault();
    const hiveId = getParam('hive') || '';
    const temp = document.querySelector('input[name="temp"]')?.value || '';
    const weather = document.querySelector('input[name="weather"]')?.value || '';
    const note = document.querySelector('input[name="note"]')?.value || '';
    const status = document.getElementById('status_input')?.value || 'OK';
    
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    const finishSave = async (imgData) => {
        let inspections = [];
        try { inspections = JSON.parse(localStorage.getItem('inspections') || '[]'); } catch (e) {}
        
        // Generate ID (Max + 1)
        let maxNum = 0;
        inspections.forEach(i => {
            if (i.id && i.id.startsWith('INSPEKSJON-')) {
                const numPart = parseInt(i.id.replace('INSPEKSJON-', ''), 10);
                if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
            }
        });
        const id = `INSPEKSJON-${String(maxNum + 1).padStart(3, '0')}`;
        
        const newInspection = { 
            id, 
            hiveId, 
            status, 
            temp, 
            weather, 
            note, 
            image: imgData, 
            ts: Date.now() 
        };
        
        if (window.REPO) {
            // Note: If image is large, Supabase insert might fail if we don't use Storage Buckets.
            // For now we try to insert. If it fails, we might want to strip the image.
            await window.REPO.addInspection(newInspection);
            
            // Redirect
            window.location.href = 'bikuber.html';
        } else {
            // Fallback
            inspections.push(newInspection);
            try { 
                localStorage.setItem('inspections', JSON.stringify(inspections)); 
                window.location.href = 'bikuber.html';
            } catch (e) {
                alert('Lagring feilet! Bildet er for stort for nettleserens lagring. Prøv et mindre bilde eller ingen bilde.');
            }
        }
    };

    if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            finishSave(evt.target.result);
        };
        reader.readAsDataURL(file);
    } else {
        finishSave(null);
    }
  }
  
  // Init
  const hiveId = getParam('hive');
  // if (hiveId) document.getElementById('page_title').textContent = `Ny Inspeksjon: ${hiveId}`; 
  
  // Actually the header id is insp_header
  if (hiveId) document.getElementById('insp_header').textContent = `Ny Inspeksjon: ${hiveId}`;
  
  // Display Date/Time
  const now = new Date();
  document.getElementById('date_display').textContent = now.toLocaleDateString('no-NO');
  document.getElementById('time_display').textContent = now.toLocaleTimeString('no-NO', {hour: '2-digit', minute:'2-digit'});

  renderStatusOptions();

  // Fetch Weather
  async function fetchWeather() {
      const tempInput = document.querySelector('input[name="temp"]');
      const weatherInput = document.querySelector('input[name="weather"]');
      
      if (!tempInput || !weatherInput) return;

      // Show loading state
      tempInput.placeholder = "Henter...";
      weatherInput.placeholder = "Henter...";

      if (!("geolocation" in navigator)) {
          tempInput.placeholder = "Ingen GPS";
          weatherInput.placeholder = "Ingen GPS";
          return;
      }

      navigator.geolocation.getCurrentPosition(async position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          try {
              const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
              if (!response.ok) throw new Error('Network response was not ok');
              const data = await response.json();
              
              if (data.current_weather) {
                  tempInput.value = `${data.current_weather.temperature}°C`;
                  
                  // Map WMO codes
                  const code = data.current_weather.weathercode;
                  let weatherDesc = "Ukjent";
                  if (code === 0) weatherDesc = "Klart";
                  else if (code <= 3) weatherDesc = "Lettskyet";
                  else if (code <= 45) weatherDesc = "Tåke";
                  else if (code <= 48) weatherDesc = "Rim";
                  else if (code <= 57) weatherDesc = "Yr";
                  else if (code <= 67) weatherDesc = "Regn";
                  else if (code <= 77) weatherDesc = "Snø";
                  else if (code <= 82) weatherDesc = "Byger";
                  else if (code <= 99) weatherDesc = "Torden";
                  
                  weatherInput.value = weatherDesc;
              }
          } catch (e) {
              console.error("Weather fetch failed", e);
              tempInput.placeholder = "Feil";
              weatherInput.placeholder = "Feil";
          }
      }, (error) => {
          console.warn("Location access denied or failed", error);
          let msg = "GPS Feil";
          if (error.code === 1) msg = "Ingen tilgang"; // Permission denied
          else if (error.code === 2) msg = "Ingen signal"; // Position unavailable
          else if (error.code === 3) msg = "Tidsavbrudd"; // Timeout
          
          tempInput.placeholder = msg;
          weatherInput.placeholder = msg;
      }, { timeout: 15000, enableHighAccuracy: false }); // Relaxed requirements
  }
  
  // Call on load
  document.addEventListener('DOMContentLoaded', () => {
      fetchWeather();
  });

  // Go to My Inspections for this hive
  window.goToMyInspections = function() {
      const hiveId = getParam('hive');
      if (hiveId) {
          window.location.href = `inspeksjoner.html?hive=${encodeURIComponent(hiveId)}`;
      } else {
          window.location.href = 'inspeksjoner.html';
      }
  };
    
  // Run on load
  window.addEventListener('load', () => {
      setTimeout(fetchWeather, 500);
  });
</script>
<script src="header.js"></script>
</html>
