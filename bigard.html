<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Bigård - Birøkter App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
    <link rel="icon" type="image/png" href="assets/icon_square.png">
    <link rel="apple-touch-icon" href="assets/icon_square.png">
</head>
<body class="bg-gray-50">

    <!-- App Viewport Container -->
    <div class="app-viewport">
        
        <!-- Header Container -->
        <div id="app-header"></div>

        <!-- Scrollable Content -->
        <div class="app-content p-4 flex flex-col items-center">
            <h2 class="text-2xl font-bold text-black mb-4">Mine bigårder</h2>

            <div id="apiaries_empty" class="w-full text-center text-gray-600 mb-4"></div>

            <!-- List -->
            <div id="apiaries_list" class="grid grid-cols-2 gap-4 w-full mb-12"></div>

            <!-- Dropdown -->
            <div id="apiaries_dropdown_container" class="w-full mb-8 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Eldre bigårder</label>
                <select id="apiaries_dropdown" class="input-std" onchange="if(this.value) window.location.href='bikuber.html?apiaryId='+encodeURIComponent(this.value)">
                    <option value="">Velg eldre bigård...</option>
                </select>
            </div>

            <!-- Action Buttons (Standard placement, not sticky) -->
            <div class="w-full pb-6">
                <button onclick="window.location.href='ny-bigard.html'" class="btn-primary">
                    Registrer Ny Bigård
                </button>
            </div>
        </div>

        <!-- Footer Container -->
        <div id="app-footer"></div>
    </div>
    
</body>
<script>
  function statusColor(s) {
    const n = (s || '').toUpperCase();
    if (n === 'OK') return 'bg-green-500';
    if (n === 'DØD') return 'bg-red-600';
    if (n === 'SYKDOM' || n === 'VARROA MISTANKE') return 'bg-orange-500';
    if (n === 'BYTT DRONNING') return 'bg-purple-500';
    if (n === 'TRENGER FÔR' || n === 'FOR LITE MAT') return 'bg-amber-500';
    if (n === 'MOTTATT FÔR' || n === 'SKIFTET RAMMER' || n === 'DRONNING SETT') return 'bg-blue-500';
    return 'bg-gray-400';
  }
  function renderApiaries() {
    let apiaries = [];
    try { apiaries = JSON.parse(localStorage.getItem('apiaries') || '[]'); } catch (e) {}
    let hives = []; let inspections = [];
    try { hives = JSON.parse(localStorage.getItem('hives') || '[]'); } catch (e) {}
    try { inspections = JSON.parse(localStorage.getItem('inspections') || '[]'); } catch (e) {}
    
    // Sort reverse
    const reversed = [...apiaries].reverse();
    const limit = 6;
    const recent = reversed.slice(0, limit);
    const older = reversed.slice(limit);

    const emptyEl = document.getElementById('apiaries_empty');
    const listEl = document.getElementById('apiaries_list');
    const dropContainer = document.getElementById('apiaries_dropdown_container');
    const dropSelect = document.getElementById('apiaries_dropdown');

    if (!apiaries.length) {
      if (emptyEl) emptyEl.textContent = 'Du har ingen registrerte bigårder ennå.';
      if (listEl) listEl.innerHTML = '';
      if (dropContainer) dropContainer.classList.add('hidden');
      return;
    }
    if (emptyEl) emptyEl.textContent = '';
    
    // Helper for name display
    const getDisplayName = (a) => {
        // "om man velger bort navn på bigården, så får den kun nummeret, og da kutter vi ut bindestreken bak, og midtstiller nummeret."
        if (a.name && a.name.trim() !== '') {
            return `${a.id} — ${a.name}`;
        } else {
            // Remove hyphen? Assuming ID format is "BIGARD-001".
            // If user meant the hyphen in "ID - Name", then it's already handled by logic.
            // But user said "kutter vi ut bindestreken bak". Maybe "BIGARD-001" -> "BIGARD 001"?
            // Or if ID is just a number?
            // Let's assume standard ID "BIGARD-XXX".
            // If no name, just return the ID, maybe formatted.
            return a.id; // Simple ID display.
        }
    };

    const isCentered = (a) => {
        return !(a.name && a.name.trim() !== '');
    };

    // Render Recent
    listEl.innerHTML = '';
    recent.forEach(a => {
        const relatedHives = hives.filter(h => h.apiaryId === a.id);
        const hiveIds = relatedHives.map(h => h.id);
        const last = inspections.filter(i => hiveIds.includes(i.hiveId)).sort((x,y)=> (y.ts||0)-(x.ts||0))[0];
        
        const btn = document.createElement('button');
        btn.className = 'relative w-full bg-[#FFD700] hover:bg-[#e6c200] text-black font-bold py-2 px-1 rounded shadow-sm transition-all text-center flex flex-col items-center justify-center min-h-[60px]';
        
        // ID
        const idSpan = document.createElement('span');
        idSpan.className = 'text-lg font-extrabold uppercase tracking-wide leading-tight';
        idSpan.textContent = a.id;
        btn.appendChild(idSpan);

        // Name
        if (a.name && a.name.trim() !== '') {
            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-[10px] font-medium opacity-80 mt-0.5 break-words w-full px-0.5 leading-tight';
            nameSpan.textContent = a.name;
            btn.appendChild(nameSpan);
        }
        
        // Type Badge (if not Bigård)
        if (a.type && a.type !== 'Bigård') {
            const typeBadge = document.createElement('span');
            typeBadge.className = 'absolute bottom-1 left-1/2 transform -translate-x-1/2 bg-black/20 text-black text-[8px] font-bold px-1 rounded-sm';
            typeBadge.textContent = a.type.toUpperCase();
            btn.appendChild(typeBadge);
        }
        
        // Status Dot
        if (last) {
          const dot = document.createElement('span');
          dot.className = `absolute top-2 right-2 w-3 h-3 rounded-full ${statusColor(last.status)} shadow-sm border border-black/10`;
          btn.appendChild(dot);
        }

        // Hive Count Badge
        const countBadge = document.createElement('span');
        countBadge.className = 'absolute top-1 right-1 bg-black text-[#FFD700] text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm z-10';
        countBadge.textContent = relatedHives.length;
        btn.appendChild(countBadge);

        // Click
        btn.onclick = () => { window.location.href = `bikuber.html?apiaryId=${encodeURIComponent(a.id)}`; };

        listEl.appendChild(btn);
    });

    // Render Older
    if (older.length > 0) {
        dropContainer.classList.remove('hidden');
        while (dropSelect.options.length > 1) { dropSelect.remove(1); }
        older.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = getDisplayName(a);
            dropSelect.appendChild(opt);
        });
    } else {
        dropContainer.classList.add('hidden');
    }
  }
  renderApiaries();
</script>
<script src="header.js"></script>
</html>
